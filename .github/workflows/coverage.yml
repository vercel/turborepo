name: Coverage

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Rust Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      COVERAGE_API_URL: ${{ secrets.COVERAGE_API_URL }}
      COVERAGE_API_TOKEN: ${{ secrets.COVERAGE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          node: "false"

      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.6

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Generate coverage report
        run: |
          if [ -z "${RUSTC_WRAPPER}" ]; then
            unset RUSTC_WRAPPER
          fi
          cargo llvm-cov nextest \
            --workspace \
            --exclude turborepo-napi \
            --json \
            --output-path coverage.json
        env:
          SCCACHE_BUCKET: turborepo-sccache
          SCCACHE_REGION: us-east-2
          RUSTC_WRAPPER: ${{ !github.event.pull_request.head.repo.fork && 'sccache' || '' }}
          CARGO_INCREMENTAL: 0
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SCCACHE_IDLE_TIMEOUT: 0
          SCCACHE_REQUEST_TIMEOUT: 30
          SCCACHE_ERROR_LOG: error

      - name: Upload coverage to reporter
        if: env.COVERAGE_API_URL != ''
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"

          # Upload coverage report using vercel curl to bypass deployment protection
          RESPONSE=$(npx vercel curl "/api/upload?sha=${{ github.sha }}&branch=${BRANCH}" \
            --deployment "${COVERAGE_API_URL}" \
            --token "${VERCEL_TOKEN}" \
            --team "${VERCEL_TEAM}" \
            -- \
            -s -X POST \
            -H "Authorization: Bearer ${COVERAGE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @coverage.json)

          echo "Upload response: $RESPONSE"

          # Extract summary for PR comment
          LINES=$(echo "$RESPONSE" | jq -r '.summary.lines.percent // 0')
          FUNCTIONS=$(echo "$RESPONSE" | jq -r '.summary.functions.percent // 0')
          BRANCHES=$(echo "$RESPONSE" | jq -r '.summary.branches.percent // 0')

          # Store for PR comment step
          echo "COVERAGE_LINES=$LINES" >> $GITHUB_ENV
          echo "COVERAGE_FUNCTIONS=$FUNCTIONS" >> $GITHUB_ENV
          echo "COVERAGE_BRANCHES=$BRANCHES" >> $GITHUB_ENV

          # Check if there's a diff
          DIFF_LINES=$(echo "$RESPONSE" | jq -r '.diff.lines // "N/A"')
          DIFF_FUNCTIONS=$(echo "$RESPONSE" | jq -r '.diff.functions // "N/A"')
          DIFF_BRANCHES=$(echo "$RESPONSE" | jq -r '.diff.branches // "N/A"')

          echo "DIFF_LINES=$DIFF_LINES" >> $GITHUB_ENV
          echo "DIFF_FUNCTIONS=$DIFF_FUNCTIONS" >> $GITHUB_ENV
          echo "DIFF_BRANCHES=$DIFF_BRANCHES" >> $GITHUB_ENV
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM: ${{ secrets.TURBO_TEAM }}

      - name: Comment on PR
        if: github.event_name == 'pull_request' && env.COVERAGE_API_URL != ''
        uses: actions/github-script@v7
        with:
          script: |
            const lines = parseFloat(process.env.COVERAGE_LINES) || 0;
            const functions = parseFloat(process.env.COVERAGE_FUNCTIONS) || 0;
            const branches = parseFloat(process.env.COVERAGE_BRANCHES) || 0;

            const diffLines = process.env.DIFF_LINES;
            const diffFunctions = process.env.DIFF_FUNCTIONS;
            const diffBranches = process.env.DIFF_BRANCHES;

            const formatDiff = (val) => {
              if (val === 'N/A' || val === 'null') return '';
              const num = parseFloat(val);
              if (isNaN(num)) return '';
              const sign = num >= 0 ? '+' : '';
              const emoji = num >= 0 ? ':chart_with_upwards_trend:' : ':chart_with_downwards_trend:';
              return ` (${sign}${num.toFixed(2)}% ${emoji})`;
            };

            const body = `## Coverage Report

            | Metric | Coverage |
            |--------|----------|
            | Lines | ${lines.toFixed(2)}%${formatDiff(diffLines)} |
            | Functions | ${functions.toFixed(2)}%${formatDiff(diffFunctions)} |
            | Branches | ${branches.toFixed(2)}%${formatDiff(diffBranches)} |

            [View full report](${process.env.COVERAGE_API_URL}/commits/${{ github.sha }})
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('## Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
