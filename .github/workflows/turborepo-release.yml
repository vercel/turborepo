# Release Pipeline
#
# This release consists of a few steps
#
# 1. Create a staging branch
# 2. Run some smoke tests on that branch
# 3. Build the Rust binary
# 4. Publish JS packages npm (including turbo itself)
# 5. Alias versioned docs (e.g., v2-5-4.turborepo.com)
# 6. Create a release branch and open a PR.

# You can opt into a dry run, which will skip publishing to npm and opening the release branch

name: Release

env:
  CARGO_PROFILE_RELEASE_LTO: true
  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
  RELEASE_TURBO_CLI: true # TODO: do we need this?

permissions:
  id-token: write # Required for npm Trusted Publishing using OIDC
  contents: write # Allow workflow to checkout code from the repository
  pull-requests: write # Allows the PR for post-release to be created

on:
  workflow_dispatch:
    inputs:
      increment:
        description: "SemVer Increment (prerelease = bump canary)"
        required: true
        default: "prerelease"
        type: choice
        options:
          # Bump the canary version of the existing semver release
          - prerelease
          # Bump to the next patch version, creating its first canary release
          - prepatch
          # Bump to the next minor version, creating its first canary release
          - preminor
          # Bump to the next major version, creating its first canary release
          - premajor
          # Bump to the next patch version
          - patch
          # Bump to the next minor version
          - minor
          # Bump to the next major version
          - major
      dry_run:
        description: "Do a dry run, skipping the final publish step."
        type: boolean
      tag-override:
        description: "Override default npm dist-tag for the release. Should only be used for backporting"
        required: false
        type: string
      ci-tag-override:
        description: "Override default npm dist-tag to use for running tests. Should only be used when the most recent release was faulty"
        required: false
        type: string
        default: ""
      sha:
        description: "Override the SHA to use for the release. Should rarely be used, usually only for debugging."
        required: false
        type: string
        default: ""

jobs:
  stage:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha || github.sha }}
      - uses: ./.github/actions/setup-node
        with:
          enable-corepack: false
      - name: Configure git
        run: |
          git config --global user.name 'Turbobot'
          git config --global user.email 'turbobot@vercel.com'
      - name: Get base SHA
        id: base-sha
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Version
        run: |
          ./scripts/version.js ${{ inputs.increment }} ${{ inputs.tag-override }}
          cat version.txt
      - name: Stage Commit
        id: stage
        run: cd cli && make stage-release && echo "STAGE_BRANCH=$(git branch --show-current)" >> $GITHUB_OUTPUT
      - name: Show Stage Commit
        run: echo "${{ steps.stage.outputs.STAGE_BRANCH }}"
    outputs:
      stage-branch: "${{ steps.stage.outputs.STAGE_BRANCH }}"
      base-sha: "${{ steps.base-sha.outputs.sha }}"

  rust-smoke-test:
    name: Rust Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [stage]
    steps:
      - name: Show Stage Commit
        run: echo "${{ needs.stage.outputs.stage-branch }}"
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.stage.outputs.stage-branch }}
      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          node: "false"

      - name: Install cargo-nextest
        uses: taiki-e/install-action@44c6d64aa62cd779e873306675c7a58e86d6d532
        with:
          tool: nextest

      - name: Run tests
        timeout-minutes: 30
        run: |
          cargo nextest run --workspace
        shell: bash

  js-smoke-test:
    name: JS Package Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [stage]
    steps:
      - name: Show Stage Commit
        run: echo "${{ needs.stage.outputs.stage-branch }}"
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.stage.outputs.stage-branch }}
      - name: Setup Environment
        uses: ./.github/actions/setup-environment
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          rust: "false"
          capnproto: "false"
      - name: Install Global Turbo
        uses: ./.github/actions/install-global-turbo
        with:
          turbo-version: "${{ github.event.inputs.ci-tag-override }}"
      - name: Run JS Package Tests
        run: turbo run check-types test --filter="./packages/*" --color

  build-rust:
    name: "Build Rust"
    needs: [stage]
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: "x86_64-apple-darwin"
          - host: macos-latest
            target: "aarch64-apple-darwin"
          - host: ubuntu-latest
            target: "x86_64-unknown-linux-musl"
            setup: "sudo apt-get update && sudo apt-get install -y build-essential clang lldb llvm libclang-dev curl musl-tools sudo unzip"
          - host: ubuntu-latest
            target: "aarch64-unknown-linux-musl"
            rust-build-env: 'CC_aarch64_unknown_linux_musl=clang AR_aarch64_unknown_linux_musl=llvm-ar RUSTFLAGS="-Clink-self-contained=yes -Clinker=rust-lld"'
            setup: "sudo apt-get update && sudo apt-get install -y build-essential musl-tools clang llvm gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu"
          - host: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.settings.host }}
    timeout-minutes: 30
    steps:
      - name: Show Stage Commit
        run: echo "${{ needs.stage.outputs.stage-branch }}"
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: "${{ needs.stage.outputs.stage-branch }}"

      - name: Setup Protoc
        uses: ./.github/actions/setup-protoc
        with:
          version: "26.x"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup capnproto
        uses: ./.github/actions/setup-capnproto

      - name: Rust Setup
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.settings.target }}
          # needed to not make it override the defaults
          rustflags: ""
          # we want more specific settings
          cache: false

      - name: Build Setup
        shell: bash
        if: ${{ matrix.settings.setup }}
        run: ${{ matrix.settings.setup }}

      - name: Build
        run: ${{ matrix.settings.rust-build-env }} cargo build --profile release-turborepo -p turbo --target ${{ matrix.settings.target }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turbo-${{ matrix.settings.target }}
          path: target/${{ matrix.settings.target }}/release-turborepo/turbo*

  npm-publish:
    name: "Publish To NPM"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [stage, build-rust, rust-smoke-test, js-smoke-test]
    steps:
      - name: Show Stage Commit
        run: echo "${{ needs.stage.outputs.stage-branch }}"
      - uses: actions/checkout@v4
        with:
          ref: "${{ needs.stage.outputs.stage-branch }}"
      - run: git fetch origin --tags
      - uses: ./.github/actions/setup-node
        with:
          enable-corepack: false

      - name: Install Global Turbo
        uses: ./.github/actions/install-global-turbo
        with:
          turbo-version: "${{ github.event.inputs.ci-tag-override }}"

      - name: Configure git
        run: |
          git config --global user.name 'Turbobot'
          git config --global user.email 'turbobot@vercel.com'

      - name: Download Rust artifacts
        uses: actions/download-artifact@v4
        with:
          path: rust-artifacts

      - name: Move Rust artifacts into place
        run: |
          mv rust-artifacts/turbo-aarch64-apple-darwin cli/dist-darwin-arm64
          mv rust-artifacts/turbo-aarch64-unknown-linux-musl cli/dist-linux-arm64
          cp -r rust-artifacts/turbo-x86_64-pc-windows-msvc cli/dist-windows-arm64
          mv rust-artifacts/turbo-x86_64-unknown-linux-musl cli/dist-linux-x64
          mv rust-artifacts/turbo-x86_64-apple-darwin cli/dist-darwin-x64
          mv rust-artifacts/turbo-x86_64-pc-windows-msvc cli/dist-windows-x64

      - name: Ensure npm version
        run: npm install -g npm@11.5.1

      - name: Perform Release
        run: cd cli && make publish-turbo SKIP_PUBLISH=${{ inputs.dry_run && '--skip-publish' || '' }}

      # Upload published artifacts in case they are needed for debugging later
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turbo-combined
          path: cli/dist

  alias-versioned-docs:
    name: "Alias Versioned Docs"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [stage, npm-publish]
    if: ${{ !inputs.dry_run }}
    outputs:
      success: ${{ steps.alias.outcome == 'success' }}
      subdomain: ${{ steps.version.outputs.subdomain }}
      version: ${{ steps.version.outputs.version }}
      docs_url: ${{ steps.alias.outputs.docs_url }}
    steps:
      - name: Checkout staging branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.stage.outputs.stage-branch }}

      - name: Get version and compute subdomain
        id: version
        run: |
          VERSION=$(head -n 1 version.txt)
          # Transform version to valid subdomain (replace dots with dashes, prepend v)
          SUBDOMAIN=$(echo "v${VERSION}" | tr '.' '-')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "subdomain=${SUBDOMAIN}" >> $GITHUB_OUTPUT
          echo "Version: v${VERSION}"
          echo "Subdomain: ${SUBDOMAIN}.turborepo.com"

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Find Vercel deployment for SHA
        id: find-deployment
        env:
          VERCEL_TOKEN: ${{ secrets.TURBO_TOKEN }}
        run: |
          SHA="${{ needs.stage.outputs.base-sha }}"
          echo "Searching for production deployment with SHA: ${SHA}"

          DEPLOYMENT_URL=$(vercel list turbo-site --scope=vercel -m githubCommitSha="${SHA}" --status=READY --token="${VERCEL_TOKEN}" 2>/dev/null | grep -E '^\S+\.vercel\.app' | head -n 1 | awk '{print $1}')

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "::error::No deployment found for SHA ${SHA}. A production deployment is created when the commit for the release is merged to main. Ensure the merge to main has completed and the Vercel build has finished before running this workflow."
            exit 1
          fi

          echo "deployment_url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT
          echo "Found production deployment."

      - name: Assign subdomain alias
        id: alias
        env:
          VERCEL_TOKEN: ${{ secrets.TURBO_TOKEN }}
        run: |
          ALIAS="${{ steps.version.outputs.subdomain }}.turborepo.com"
          DEPLOYMENT_URL="${{ steps.find-deployment.outputs.deployment_url }}"

          echo "Assigning alias ${ALIAS} to deployment ${DEPLOYMENT_URL}"

          vercel alias set "${DEPLOYMENT_URL}" "${ALIAS}" --token="${VERCEL_TOKEN}" --scope=vercel

          echo "docs_url=https://${ALIAS}" >> $GITHUB_OUTPUT
          echo "Successfully aliased to https://${ALIAS}"

      - name: Notify Slack on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "Versioned docs aliasing failed for v${{ steps.version.outputs.version }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "Versioned Docs Aliasing Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ steps.version.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Target Subdomain:*\n${{ steps.version.outputs.subdomain }}.turborepo.com"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*SHA:*\n${{ steps.get-sha.outputs.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployment URL:*\n${{ steps.find-deployment.outputs.deployment_url || 'Not found' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Workflow Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.TURBOREPO_REPO_STATS_SLACK_WEBHOOK_URL }}

  create-release-pr:
    name: "Open Release Branch PR"
    needs: [stage, npm-publish, alias-versioned-docs]
    if: ${{ always() && needs.npm-publish.result == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Show Stage Commit
        run: echo "${{ needs.stage.outputs.stage-branch }}"
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.stage.outputs.stage-branch }}
      - name: Get version
        id: getVersion
        run: echo "version=$(head -n 1 version.txt)" >> $GITHUB_OUTPUT

      - name: Build PR Body
        id: pr-body
        run: |
          cat << 'EOFHEADER' > pr-body.md
          EOFHEADER

          if [ "${{ needs.alias-versioned-docs.result }}" != "success" ]; then
            cat << 'EOFWARNING' >> pr-body.md
          > [!CAUTION]
          > ## VERSIONED DOCS ALIASING FAILED
          >
          > The documentation alias to `${{ needs.alias-versioned-docs.outputs.subdomain }}.turborepo.com` **FAILED**.
          >
          > **Action Required:** Manually investigate and create the alias.
          >
          > [View the failed workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---

          EOFWARNING
          else
            cat << EOFSUCCESS >> pr-body.md
          Versioned docs available at: https://${{ needs.alias-versioned-docs.outputs.subdomain }}.turborepo.com

          ---

          EOFSUCCESS
          fi

          echo "Release PR for turborepo v${{ steps.getVersion.outputs.version }}" >> pr-body.md

          {
            echo "body<<EOFBODY"
            cat pr-body.md
            echo "EOFBODY"
          } >> $GITHUB_OUTPUT

      - name: Create pull request
        uses: thomaseizinger/create-pull-request@master
        if: ${{ !inputs.dry_run }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          head: ${{ needs.stage.outputs.stage-branch }}
          base: main
          title: "release(turborepo): ${{ steps.getVersion.outputs.version }}"
          body: ${{ steps.pr-body.outputs.body }}
